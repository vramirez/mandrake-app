<!DOCTYPE html>
<html lang='en'>
  <head>
    <meta charset='utf-8'>
    <meta name='viewport' content='width=device-width, initial-scale=1'>
    <title>MandrakeApp - Eventos Online gratuitos #QuedateEnCasa</title>
    
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
    <script src="https://ajax.googleapis.com/ajax/libs/angularjs/1.5.6/angular.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.3/umd/popper.min.js"></script>
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.1.1/js/bootstrap.min.js"></script>
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.4.1/css/bootstrap.min.css" integrity="sha384-Vkoo8x4CGsO3+Hhxv8T/Q5PaXtkKtu6ug5TOeNV6gBiFeWPGFN9MuhOf23Q9Ifjh" crossorigin="anonymous">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">
    <link href="css/index.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/popper.js@1.16.0/dist/umd/popper.min.js" integrity="sha384-Q6E9RHvbIyZFJoft+2mJbHaEWldlvI9IOYy5n3zV9zzTtmI3UksdQRVvoxMfooAo" crossorigin="anonymous"></script>
    <script src="https://sdk.amazonaws.com/js/aws-sdk-2.135.0.min.js"></script>
    <script src="js/aws-cognito-sdk.min.js"></script>
    <script src="js/amazon-cognito-identity.min.js"></script>
  </head>
  <body>
    <br>
    <div class="container">
      <div class='btn-toolbar float-right'>

        <p id="welcomeLabel" class="d-none"></p>
        <br>
        <p></p>
        <button type="button" id="logInButton" class="btn btn-info btn-lg" data-toggle="modal" data-target="#loginModal">Login / Registro</button>
        <button type="button" id="logOutButton" class="btn btn-danger btn-lg d-none">Salir</button>
        
      </div>
    </div>
    <div class="modal fade" id="loginModal" tabindex="-1" role="dialog" aria-hidden="true">
      <div class="modal-dialog">
        <div class="modal-content">
          <!-- Modal Header -->
          <div class="modal-header">
            <button type="button" class="close" data-dismiss="modal">
            <span aria-hidden="true">&times;</span>
            <span class="sr-only">Close</span>
          </button>
        </div>
        <!-- Modal Body -->
        <div class="modal-body">
          <form id="loginForm">
            <input type="text" id ="email" name="email" placeholder="Email" />
            <input type="password" id="pwd" name="pwd" placeholder="Password" />
            <input type="submit" id="login-modal-button" name="login" class="btn btn-info" value="Login"/ >
          </form>
          <div class="login-help">
            <a href="register.html">Registro</a>
          </div>
        </div>
      </div>
    </div>
  </div>
    <div class='container'>
        <h1>Mandrake App</h1>
        <p><font size=4>A continuacion, listado de eventos online <b>#QuedateEnCasa</b> ¡Todos los días hay eventos nuevos! </p>
        <p>Los eventos resaltados ocurren <b>HOY</b>, ¡no te los pierdas!</font></p>
        <p id='loading'><em>Loading events...</em></p>
        <div class='wrap'>
            <table class='table table-responsive' style='display: none'>
                <tr>
                    <th>Artista(s)</th>
                    <th>Tipo</th>
                    <th>Evento</th>
                    <th>Fecha Hora COL/MEX</th>
                    <th>Fecha Hora ARG</th>
                    <th  align="center">Link</th>
                </tr>
            </table>
        </div>
    </div>
    
    <script>
    // var cognitoUserPoolId = 'us-east-1_PnJomwg3k';  
    // var cognitoUserPoolClientId = '1updq8ff0evr7lj4b6mms9olrj';
     var cognitoUserPoolId = 'us-east-1_mP9Mp5gQA';  // example: 'us-east-1_abcd12345'
    var cognitoUserPoolClientId = '4ggndrsi201o310br9f46ahbsi'; // example: 'abcd12345abcd12345abcd12345'
    var awsRegion = 'us-east-1'; 
    var api_gateway_url = 'https://97acbbng16.execute-api.us-east-1.amazonaws.com/prod/getTodayNewer';
    var app = angular.module('mysfitsApp', []);
    var socialMedia=['facebook','twitter','instagram','youtube','tumblr']
    var gridScope;

    var filterScope;

    var profileScope;

    initializeStorage();

    var configString = localStorage.getItem("awsConfig");
    var config = JSON.parse(configString);
    if(config != null) {
      refreshAWSCredentials();
      loggedInDisplay();
    }

    $(document).ready(function() {
        //var api_gateway_url = 'https://97acbbng16.execute-api.us-east-1.amazonaws.com/prod/getTodayNewer';
        
        var rows = [];
        var tudei = false
        $.getJSON(api_gateway_url, function(data) {
          data.forEach(function(item) {
            tudei=sameDay(new Date(),new Date(item['date']))
              
                rows.push(`<tr ${printHighlight(tudei)}> \
                  
                    <td>${showItem(item,'photo')}</td> \
                    <td>${getEventType(item)}</td> \
                    <td>${showItem(item,'event')}</td> \
                    <td>${formatDate(item['date'],0)}</td> \
                    <td>${formatDate(item['date'],+2)}</td>\      
                    ${printLinks(item['link'])}\
                    
                </tr>`);
            });
            $('table.table').append(rows.join()).show();
            $('#loading').hide();
        });
    });
    
    function printLinks(links){
      //alert(links[0]['url'])
      var ret=''
      for (var i=0;i<links.length;i++){        
        ret+='<td><a href="'+links[i]['url']+'" target=\"_blank\" '+getSocialMediaIcon(links[i]['media'])+'>'+getMediatext(links[i]['media'])+'</a></td>'
      }
      return ret
    }

    function sameDay(d1, d2) {
    return d1.getFullYear() === d2.getFullYear() &&     d1.getMonth() === d2.getMonth() &&    d1.getDate() === d2.getDate();
}
  function printHighlight(bool){
        if (bool)
          
        return ' bgcolor="#00DD88" '
          //else return ''
      }
      function printB2(bool){
        if (bool)          
        return '</b>'
        else return ''
      }

    function formatDate(date,utc) {
    var d = new Date(new Date(date).getTime()+(utc*3600*1000));
    if (isAppleDevice()) {
          var t = date.split(/[- :]/);

        // Apply each element to the Date function
          var d = new Date(new Date(t[0], t[1]-1, t[2], t[3], t[4], 0).getTime()+(utc*3600*1000));
          //var actiondate = new Date(d);
          /*var dateParts = date.substring(0,10).split('-');
          var timePart = date.substr(11);
          date= dateParts[1] + '/' + dateParts[2] + '/' + dateParts[0] + ' ' + timePart;*/
      } 
        month = '' + (d.getMonth() + 1),
        day = '' + d.getDate(),
        year = d.getFullYear(),
        hours=''+d.getHours(),
        mins=''+d.getMinutes();
        if (isAppleDevice()) {
          var t = date.split(/[- :]/);

        // Apply each element to the Date function
          var d = new Date(t[0], t[1]-1, t[2], t[3], t[4], t[5]);
          var actiondate = new Date(d);
          /*var dateParts = date.substring(0,10).split('-');
          var timePart = date.substr(11);
          date= dateParts[1] + '/' + dateParts[2] + '/' + dateParts[0] + ' ' + timePart;*/
      } 
    if (month.length < 2) 
        month = '0' + month;
    if (day.length < 2) 
        day = '0' + day;
    if(hours.length<2)
        hours = '0'+hours;
    if (mins.length<2)
        mins = '0'+mins;
    
    deit=[year, month, day].join('-')
    taim=[hours,mins].join(':')
    return deit+' '+taim;
    }

    function getSocialMediaIcon(media){
      var socialMedia=['facebook','twitter','instagram','youtube','tumblr']
      media=media.toLowerCase()
      if (socialMedia.includes(media)){
       return ' class="fa fa-'+media+'" '
      }else{
        return ''

      }
    }
    /*
    
    */
    function getMediatext(media){
      var socialMedia=['facebook','twitter','instagram','youtube','tumblr']
      if (socialMedia.includes(media.toLowerCase())){
      return ' '
      
      }else{
        return 'Sitio Evento'

      }
    }

    function getEventType(item){
      type=item['type']
      switch(type){
      case "music":
      return "Concierto"
      case "talk":
      return "Charla"
      case "art":
      return "Arte y Cultura"
      case "workshop":
        return "Taller"
      default :
        return "N/A"
      }
    }

    function showItem(item,key){
      var ret=''

      switch(key){
        case 'photo':
        var artist=item['artist']
        if(key in item)
          ret+=`<img src="${item[key]}"  width="100" height="100"> <br>${artist}`
        else
          ret+=`${artist}`
          break;
        case 'event':
          if (key in item){
            ret+=`${item[key]}`
          }else{
            ret+=''
          }
          break;
          default:
          return ''
      }
      return ret
    }

    function loggedInDisplay() {
      $("#logInButton").addClass("d-none");
      $("#logOutButton").removeClass("d-none");
      $("#loginModal").modal("hide");
      document.getElementById("welcomeLabel").innerHTML = "Bienvenid@ "+localStorage.getItem('email')+"    ";
      $("#welcomeLabel").removeClass("d-none")
      //alert
    }

    function initializeStorage() {
      var identityPoolId = cognitoUserPoolId;//
      var userPoolId = cognitoUserPoolId; //
      var clientId = cognitoUserPoolClientId;//
      var loginPrefix = 'cognito-idp.' + awsRegion + '.amazonaws.com/' + identityPoolId;
      //alert("local "+cognitoUserPoolId)
      localStorage.setItem('identityPoolId', identityPoolId);
      localStorage.setItem('userPoolId', userPoolId);
      localStorage.setItem('clientId', clientId);
      localStorage.setItem('loginPrefix', loginPrefix);
      localStorage.setItem('name','test')
    }


  $(document).on('click', '#logOutButton', function(event) {
    localStorage.clear();
    document.location.reload();
  });


    function loginUser() {
      var userPoolId = localStorage.getItem('userPoolId');
      var clientId = localStorage.getItem('clientId');
      var identityPoolId = localStorage.getItem('identityPoolId');
      var loginPrefix = localStorage.getItem('loginPrefix');
      var poolData = {
        UserPoolId : userPoolId, // Your user pool id here
        ClientId : clientId // Your client id here
      
      };
      var userPool = new AmazonCognitoIdentity.CognitoUserPool(poolData);

      var email = document.getElementById('email').value;
      var pwd = document.getElementById('pwd').value;

      var authenticationData =
      {
        'UserName': email,
        'Password': pwd
      }
      var userData = {
        Username : email,
        Pool : userPool
      };

      var authenticationDetails = new AmazonCognitoIdentity.AuthenticationDetails(authenticationData);
      var cognitoUser = new AmazonCognitoIdentity.CognitoUser(userData);
      cognitoUser.authenticateUser(authenticationDetails, {
        onSuccess: function (result) {
          //console.log('access token + \n' + result.getAccessToken().getJwtToken());

          var sessionTokens =
          {
            IdToken: result.getIdToken(),
            AccessToken: result.getAccessToken(),
            RefreshToken: result.getRefreshToken()
          };
          localStorage.setItem('sessionTokens', JSON.stringify(sessionTokens));

          //POTENTIAL: Region needs to be set if not already set previously elsewhere.
          AWS.config.region = 'us-east-1';
          AWS.config.credentials = new AWS.CognitoIdentityCredentials({
            IdentityPoolId : identityPoolId, // your identity pool id here
            Logins : {
              // Change the key below according to the specific region your user pool is in.
               loginPrefix : sessionTokens.IdToken.jwtToken
            }
          });
          localStorage.setItem('awsConfig', JSON.stringify(AWS.config));
          localStorage.setItem('email', email);
          //localStorage.setItem('email', email);

          cognitoUser.getUserAttributes(function(err, result) {
            if (err) {
                alert(err);
                return;
            }
            for (i = 0; i < result.length; i++) {
                console.log('attribute ' + result[i].getName() + ' has value ' + result[i].getValue());
                //localStorage.setItem('')
                if (result[i].getName() == 'sub') {
                  console.log('Overwriting userId into local storage');
                  localStorage.setItem('userId', result[i].getValue());
                }
               if (result[i].getName() == 'given_name') {
                  console.log('Wrtiting Name '+result[i].getValue());
                  localStorage.setItem('name', result[i].getValue());
                
                }
            }
          });

          loggedInDisplay();
        },

        onFailure: function(err) {
          //alert("alertinha!")
          alert(err.message);
        },

      });
    }

    function refreshAWSCredentials() {

      var userPoolId = localStorage.getItem('userPoolId');
      var clientId = localStorage.getItem('clientId');
      var identityPoolId = localStorage.getItem('identityPoolId');
      var loginPrefix = localStorage.getItem('loginPrefix');

      var poolData = {
        UserPoolId : userPoolId, // Your user pool id here
        ClientId : clientId // Your client id here
      };
      var userPool = new AmazonCognitoIdentity.CognitoUserPool(poolData);
      var cognitoUser = userPool.getCurrentUser();

      if (cognitoUser != null) {
            cognitoUser.getSession(function(err, result) {
                if (result) {
                    console.log('You are now logged in.');
                    cognitoUser.refreshSession(result.getRefreshToken(), function(err, result) {

                        if (err) {//throw err;
                            console.log('In the err: '+err);
                        }
                        else{
                            localStorage.setItem('awsConfig', JSON.stringify(AWS.config));
                            var sessionTokens =
                            {
                              IdToken: result.getIdToken(),
                              AccessToken: result.getAccessToken(),
                              RefreshToken: result.getRefreshToken()
                            };
                            localStorage.setItem("sessionTokens", JSON.stringify(sessionTokens));

                        }
                    });

                }
            });
        }


    }

    $("#loginForm").submit(function(event) {
      event.preventDefault();
      loginUser();
    });

    app.controller('clearFilterController', function($scope) {
    });

    app.controller('mysfitsFilterController', function($scope) {

      filterScope = $scope;

      // The possible options for Mysfits to populate the dropdown filters.
      $scope.filterOptionsList =
       {
         "categories": [
           {
             "title": "Good/Evil",
             "selections":  [
               "Good",
               "Neutral",
               "Evil"
             ]
           },
           {
             "title": "Lawful/Chaotic",
             "selections":  [
               "Lawful",
               "Neutral",
               "Chaotic"
             ]
           }
         ]
       };

       $scope.removeFilter = function() {
         allMysfits = getAllMysfits(applyGridScope);
       }

       $scope.queryMysfits = function(filterCategory, filterValue) {

           var filterCategoryQS = "";
           if (filterCategory==="Good/Evil") {
             filterCategoryQS = "GoodEvil";
           } else {
             filterCategoryQS = "LawChaos"
           }
           var mysfitsApi = mysfitsApiEndpoint + '/mysfits?' + 'filter=' + filterCategoryQS + "&value=" + filterValue;

           $.ajax({
             url : mysfitsApi,
             type : 'GET',
             success : function(response) {
               applyGridScope(response.mysfits)
             },
             error : function(response) {
               console.log("could not retrieve mysfits list.");
               if (response.status == "401") {
                  refreshAWSCredentials();
                }
             }
           });
       }



    });

    app.controller('mysfitsListController', function($scope) {

      gridScope = $scope;

      getAllMysfits(applyGridScope);



      $scope.likeClicked = function(mysfitId) {
        console.log("clicked: " + mysfitId);
        likeMysfit(mysfitId, updateLikeIcons);
      }

    });

    app.controller('mysfitProfileController', function($scope) {

      profileScope = $scope;

      $scope.adoptClicked = function(mysfitId) {
        console.log("adopt clicked: " +  mysfitId);
        adoptMysfit(mysfitId, markAdopted);
      }

    });

    $('#profileModal').on('show.bs.modal', function (event) {
      var button = $(event.relatedTarget);
      var mysfitId = button.data('mysfitid');
      getMysfit(mysfitId, updateModalText);


    });

    function updateModalText(profileMysfit) {

      applyProfileScope(profileMysfit);

      if (profileMysfit.adopted == true) {
        markAdopted();
      } else {
        markNotAdopted();
      }

    }

    function markAdopted() {
      $("#adoptButton").addClass("d-none");
      $("#alreadyAdoptedButton").removeClass("d-none");
    }

    function markNotAdopted() {
      $("#adoptButton").removeClass("d-none");
      $("#alreadyAdoptedButton").addClass("d-none");
    }

    function updateLikeIcons(mysfitId) {

      likeIconId = "#" + mysfitId + "LikeIcon";
      $(likeIconId).addClass("d-none");

      alreadyLikedIconId = "#" + mysfitId + "AlreadyLikedIcon";
      $(alreadyLikedIconId).removeClass("d-none");

    }

    function applyGridScope(mysfitsList) {
      gridScope.mysfits = mysfitsList;
      gridScope.$apply();
    }

    function applyProfileScope(mysfit) {
      profileScope.profileMysfit = mysfit;
      profileScope.$apply();
    }

    function likeMysfit(mysfitId, callback) {

      try {
        var mysfitsApi = mysfitsApiEndpoint + '/mysfits/' + mysfitId + "/like";

        var sessionTokensString = localStorage.getItem('sessionTokens');
        var sessionTokens = JSON.parse(sessionTokensString);
        var IdToken = sessionTokens.IdToken;
        var idJwt = IdToken.jwtToken;

        $.ajax({
          url : mysfitsApi,
          type : 'POST',
          headers : {'Authorization' : idJwt },
          success : function(response) {
            console.log("here" + mysfitId);
            callback(mysfitId);
          },
          error : function(response) {
            console.log("could not like mysfit");
            console.log(response);
            if (response.status == "401") {
               refreshAWSCredentials();
             }
          }
        });
      } catch(err) {
        alert("You must be logged in to like a mysfit.");
        console.log(err.message);
      }

    }

    function adoptMysfit(mysfitId, callback) {

      try {
        var mysfitsApi = mysfitsApiEndpoint + '/mysfits/' + mysfitId + "/adopt";

        var sessionTokensString = localStorage.getItem('sessionTokens');
        var sessionTokens = JSON.parse(sessionTokensString);
        var IdToken = sessionTokens.IdToken;
        var idJwt = IdToken.jwtToken;

        $.ajax({
          url : mysfitsApi,
          async : false,
          type : 'POST',
          headers : {'Authorization' : idJwt },
          success : function(response) {
            callback();
          },
          error : function(response) {
            console.log("could not adopt mysfit");
            if (response.status == "401") {
               refreshAWSCredentials();
             }
          }
        });
      } catch (err) {
        alert("You must be logged in to adopt a mysfit.");
        console.log(err.message);
      }

    }

    function getAllMysfits(callback) {

      var mysfitsApi = mysfitsApiEndpoint + '/mysfits';

      $.ajax({
        url : mysfitsApi,
        type : 'GET',
        success : function(response) {
          callback(response.mysfits);
        },
        error : function(response) {
          console.log("could not retrieve mysfits list.");
          if (response.status == "401") {
             refreshAWSCredentials();
           }
        }
      });
    }

    function getMysfit(mysfitId, callback) {

      var mysfitsApi = mysfitsApiEndpoint + '/mysfits/' + mysfitId;

      $.ajax({
        url : mysfitsApi,
        type : 'GET',
        success : function(response) {
          callback(response);
        },
        error : function(response) {
          console.log("could not retrieve mysfits list.");
          if (response.status == "401") {
             refreshAWSCredentials();
           }
        }
      });
    }
    function isAppleDevice() {
    if (navigator.userAgent.match(/(iPhone|iPod|iPad)/) != null) {
      return true;
    }
    return false;
    }
    </script>
  </body>
  <div align="center">
 <p>Si conoces algún evento que podamos incluir, no dudes en contactarnos a nuestro email: <b>mandrakeapp2020 en Gmail</b></p>
</div>
</html>
